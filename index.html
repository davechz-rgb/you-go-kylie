<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Periodic League ‚öΩüß™</title>
<style>
:root{
  --bg1:#02110a; --bg2:#0b5a23;
  --card:rgba(0,0,0,.45);
  --line:rgba(255,255,255,.14);
  --ledRed:#ff2d2d; --ledRedDim:rgba(255,45,45,.18);
  --good:#2ecc71; --bad:#ff4d6d;
}
*{box-sizing:border-box}
body{
  margin:0; color:#fff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
/* Stadium Scoreboard */
.topbar{position:sticky;top:0;z-index:10;padding:12px;background:rgba(0,0,0,.55);border-bottom:1px solid var(--line)}
.board{
  margin:0 auto;max-width:980px;
  background:linear-gradient(180deg, rgba(10,10,10,.92), rgba(0,0,0,.82));
  border:1px solid rgba(255,255,255,.22);
  border-radius:14px;
  box-shadow:0 18px 55px rgba(0,0,0,.55);
  padding:12px 14px;
}
.boardGrid{display:grid; gap:10px; align-items:center; grid-template-columns: 1fr auto 1fr;}
.teamBlock{text-align:center}
.teamLabel{font-weight:900; letter-spacing:2px; font-size:13px; color:rgba(255,255,255,.85);}
.led{
  display:inline-block;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-weight:900;
  letter-spacing:2px;
  color:var(--ledRed);
  text-shadow: 0 0 6px var(--ledRedDim), 0 0 18px var(--ledRedDim), 0 0 36px rgba(255,45,45,.10);
}
.scoreDigits{font-size:52px; line-height:1; padding:4px 10px; border-radius:10px;
  background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.14);
}
.centerBlock{text-align:center}
.centerRow{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
.clockBox{padding:8px 12px;border-radius:12px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.14)}
.clockTitle{font-size:11px;letter-spacing:2px;font-weight:900;color:rgba(255,255,255,.75)}
.clockTime{font-size:40px}
.miniHud{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.08);font-weight:900;}
.btn{padding:9px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;font-weight:900;cursor:pointer; user-select:none;}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn.toggleOff{opacity:.7; filter:grayscale(.2)}

.wrap{max-width:980px;margin:18px auto;padding:0 12px}
.container{background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:0 22px 70px rgba(0,0,0,.55);padding:18px;text-align:center;}
.question{font-size:22px;font-weight:1000;margin:8px 0 10px}
.fact{margin-top:8px;min-height:22px;font-size:14px;opacity:.92;color:rgba(255,255,255,.92)}
.fact strong{color:#fff}
.options{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
@media (max-width:640px){.options{grid-template-columns:1fr} .scoreDigits{font-size:44px} .clockTime{font-size:34px}}
.option{padding:14px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.08);color:#fff;font-size:16px;font-weight:1000;cursor:pointer;}
.option.correct{background:rgba(46,204,113,.28)}
.option.wrong{background:rgba(255,77,109,.28)}
.option.hidden{visibility:hidden}
.penalty{position:relative;font-size:70px;height:90px;display:flex;align-items:center;justify-content:center}
.flashText{
  position:absolute; left:50%; top:50%;
  transform:translate(-50%,-50%);
  font-weight:1000; letter-spacing:2px; text-transform:uppercase;
  padding:10px 16px; border-radius:999px;
  border:1px solid rgba(255,255,255,.20);
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
  font-size:34px; line-height:1; opacity:0; pointer-events:none;
}
.flashText.goal{color: var(--good); text-shadow: 0 0 18px rgba(46,204,113,.25);}
.flashText.miss{color: var(--bad); text-shadow: 0 0 18px rgba(255,77,109,.25);}
.flashText.showGoal{animation: goalPop 950ms ease-out forwards;}
.flashText.showMiss{animation: missPop 950ms ease-out forwards;}
@keyframes goalPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.7) rotate(-3deg)}12%{opacity:1;transform:translate(-50%,-56%) scale(1.15) rotate(2deg)}40%{opacity:1;transform:translate(-50%,-60%) scale(1.08) rotate(-1deg)}70%{opacity:.95;transform:translate(-50%,-58%) scale(1.02)}100%{opacity:0;transform:translate(-50%,-52%) scale(.92)}}
@keyframes missPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.85)}15%{opacity:1;transform:translate(-50%,-54%) scale(1.05)}35%{opacity:1;transform:translate(-50%,-52%) scale(1.0)}70%{opacity:1;transform:translate(-50%,-50%) scale(.98)}100%{opacity:0;transform:translate(-50%,-48%) scale(.92)}}

.footer{margin-top:10px;font-size:13px;opacity:.82}

/* Modals */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px;
  background:rgba(0,0,0,.62); backdrop-filter: blur(10px); z-index:50;}
.modal.show{display:flex}
.modalCard{width:min(860px, 100%); background:linear-gradient(180deg, rgba(20,20,20,.92), rgba(0,0,0,.85));
  border:1px solid rgba(255,255,255,.18); border-radius:18px; box-shadow:0 24px 80px rgba(0,0,0,.65); padding:16px;}
.modalHeader{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;}
.modalTitle{font-weight:1000; letter-spacing:.3px; font-size:18px;}
.leagueGrid{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
@media (max-width:720px){ .leagueGrid{grid-template-columns:1fr} }
.leagueBtn{text-align:left; border-radius:16px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06);
  padding:14px; cursor:pointer; color:#fff; font-weight:1000;}
.leagueBtn:hover{background:rgba(255,255,255,.10)}
.leagueName{font-size:16px; font-weight:1000}
.leagueDesc{margin-top:6px; font-size:13px; opacity:.9; font-weight:800}
.leagueDesc strong{color:#fff}
.examBox{margin-top:12px; padding:12px; border-radius:16px; border:1px dashed rgba(255,255,255,.18); background:rgba(255,255,255,.04);}
.examRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
.examLabel{font-weight:900; opacity:.9}
.examInput{width:110px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.35); color:#fff; font-weight:1000;}
.examHint{margin-top:8px; font-size:12px; opacity:.8}
.modalFooter{margin-top:12px}
.smallMuted{font-size:12px; opacity:.8}
.resultBig{font-size:40px; font-weight:1000; margin:6px 0 10px; color: var(--ledRed); text-shadow: 0 0 10px rgba(255,45,45,.18);}
.resultStats{font-size:14px; opacity:.92; margin-bottom:12px}
.resultListTitle{font-size:13px; opacity:.85; font-weight:900; margin-top:6px}
.resultList{margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;}
.tag{padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); font-weight:900; font-size:13px;}
</style>
</head>
<body>

<div class="topbar">
  <div class="board">
    <div class="boardGrid">
      <div class="teamBlock">
        <div class="teamLabel">HOME</div>
        <div class="led scoreDigits"><span id="homeScore">00</span></div>
      </div>

      <div class="centerBlock">
        <div class="centerRow">
          <div class="clockBox">
            <div class="clockTitle">TIME</div>
            <div class="led clockTime" id="clock">01:00</div>
          </div>
        </div>
        <div class="miniHud" style="margin-top:10px">
          <div class="pill">‚úÖ Correctas: <span id="correct">0</span></div>
          <div class="pill">‚ùå Fallos: <span id="wrong">0</span></div>
          <div class="pill">üèÜ Liga: <span id="leagueName">Segunda Divisi√≥n</span></div>
          <div class="pill" id="examPill" style="display:none">üìù Preguntas: <span id="examProg">0/0</span></div>
          <button class="btn" id="jokerBtn">üÉè 50/50 (<span id="jokersLeft">3</span>)</button>
          <button class="btn" id="sfxBtn">üîä SFX: ON</button>
          <button class="btn" id="menuBtn">‚ò∞ MEN√ö</button>
        </div>
      </div>

      <div class="teamBlock">
        <div class="teamLabel">GUEST</div>
        <div class="led scoreDigits"><span id="guestScore">00</span></div>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="container">
    <div class="penalty" id="penalty">
      <div id="flash" class="flashText"></div>
    </div>
    <div class="question" id="question"></div>
    <div class="fact" id="fact"></div>
    <div class="options" id="options"></div>
    <div class="footer">Periodic League ¬∑ Comod√≠n 50/50 (3 usos) ¬∑ Vibraci√≥n m√≥vil + SFX (toggle)</div>
  </div>
</div>

<!-- Main Menu -->
<div class="modal" id="menuModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHeader">
      <div class="modalTitle">Selecciona una liga</div>
      <button class="btn" id="closeMenuBtn">‚úï</button>
    </div>

    <div class="leagueGrid">
      <button class="leagueBtn" data-league="0">
        <div class="leagueName">Segunda Divisi√≥n</div>
        <div class="leagueDesc">Solo <strong>s√≠mbolo ‚Üî elemento</strong>.</div>
      </button>
      <button class="leagueBtn" data-league="1">
        <div class="leagueName">Primera Divisi√≥n</div>
        <div class="leagueDesc">Solo <strong>n√∫mero at√≥mico</strong>.</div>
      </button>
      <button class="leagueBtn" data-league="2">
        <div class="leagueName">Liga Inglesa</div>
        <div class="leagueDesc">Solo <strong>familias qu√≠micas</strong>.</div>
      </button>
      <button class="leagueBtn" data-league="3">
        <div class="leagueName">Champions League (Examen)</div>
        <div class="leagueDesc"><strong>Todo mezclado</strong> + resultado final.</div>
      </button>
    </div>

    <div class="examBox" id="examBox" style="display:none">
      <div class="examRow">
        <label for="examCount" class="examLabel">Cantidad de preguntas</label>
        <input id="examCount" class="examInput" type="number" min="5" max="60" value="20" />
        <button class="btn" id="startExamBtn">Iniciar examen</button>
      </div>
      <div class="examHint">Tip: 20‚Äì30 preguntas es perfecto para una sesi√≥n r√°pida.</div>
    </div>

    <div class="modalFooter">
      <div class="smallMuted">Puedes entrar al men√∫ en cualquier momento. Si est√°s jugando, te preguntar√° antes de salir.</div>
    </div>
  </div>
</div>

<!-- Confirm Exit -->
<div class="modal" id="confirmModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHeader">
      <div class="modalTitle">¬øSalir del partido?</div>
      <button class="btn" id="closeConfirmBtn">‚úï</button>
    </div>
    <div class="resultStats">El partido actual se dar√° por terminado. ¬øDeseas continuar?</div>
    <div class="modalFooter" style="display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap">
      <button class="btn" id="cancelExitBtn">Cancelar</button>
      <button class="btn" id="confirmExitBtn">Salir al men√∫</button>
    </div>
  </div>
</div>

<!-- Exam result -->
<div class="modal" id="resultModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHeader">
      <div class="modalTitle">Resultado ‚Äî Champions League</div>
      <button class="btn" id="closeResultBtn">‚úï</button>
    </div>
    <div class="resultBig" id="resultBig">‚Äî</div>
    <div class="resultStats" id="resultStats">‚Äî</div>
    <div class="resultListTitle">Elementos para reforzar (los que fallaste):</div>
    <div class="resultList" id="weakList"></div>
    <div class="modalFooter" style="display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap">
      <button class="btn" id="restartExamBtn">Reintentar examen</button>
      <button class="btn" id="backToMenuBtn">Volver al men√∫</button>
    </div>
  </div>
</div>

<script>
const ELEMENTS = [
{name:'Hidr√≥geno',symbol:'H',number:1,family:'No metal'},
{name:'Helio',symbol:'He',number:2,family:'Gas noble'},
{name:'Litio',symbol:'Li',number:3,family:'Metal alcalino'},
{name:'Berilio',symbol:'Be',number:4,family:'Alcalinot√©rreo'},
{name:'Boro',symbol:'B',number:5,family:'Metaloide'},
{name:'Carbono',symbol:'C',number:6,family:'No metal'},
{name:'Nitr√≥geno',symbol:'N',number:7,family:'No metal'},
{name:'Ox√≠geno',symbol:'O',number:8,family:'No metal'},
{name:'Fl√∫or',symbol:'F',number:9,family:'Hal√≥geno'},
{name:'Ne√≥n',symbol:'Ne',number:10,family:'Gas noble'},
{name:'Sodio',symbol:'Na',number:11,family:'Metal alcalino'},
{name:'Magnesio',symbol:'Mg',number:12,family:'Alcalinot√©rreo'},
{name:'Aluminio',symbol:'Al',number:13,family:'Metal postransici√≥n'},
{name:'Silicio',symbol:'Si',number:14,family:'Metaloide'},
{name:'F√≥sforo',symbol:'P',number:15,family:'No metal'},
{name:'Azufre',symbol:'S',number:16,family:'No metal'},
{name:'Cloro',symbol:'Cl',number:17,family:'Hal√≥geno'},
{name:'Arg√≥n',symbol:'Ar',number:18,family:'Gas noble'},
{name:'Potasio',symbol:'K',number:19,family:'Metal alcalino'},
{name:'Calcio',symbol:'Ca',number:20,family:'Alcalinot√©rreo'},
{name:'Escandio',symbol:'Sc',number:21,family:'Metal de transici√≥n'},
{name:'Titanio',symbol:'Ti',number:22,family:'Metal de transici√≥n'},
{name:'Vanadio',symbol:'V',number:23,family:'Metal de transici√≥n'},
{name:'Cromo',symbol:'Cr',number:24,family:'Metal de transici√≥n'},
{name:'Manganeso',symbol:'Mn',number:25,family:'Metal de transici√≥n'},
{name:'Hierro',symbol:'Fe',number:26,family:'Metal de transici√≥n'},
{name:'Cobalto',symbol:'Co',number:27,family:'Metal de transici√≥n'},
{name:'N√≠quel',symbol:'Ni',number:28,family:'Metal de transici√≥n'},
{name:'Cobre',symbol:'Cu',number:29,family:'Metal de transici√≥n'},
{name:'Zinc',symbol:'Zn',number:30,family:'Metal de transici√≥n'},
{name:'Galio',symbol:'Ga',number:31,family:'Metal postransici√≥n'},
{name:'Germanio',symbol:'Ge',number:32,family:'Metaloide'},
{name:'Ars√©nico',symbol:'As',number:33,family:'Metaloide'},
{name:'Selenio',symbol:'Se',number:34,family:'No metal'},
{name:'Bromo',symbol:'Br',number:35,family:'Hal√≥geno'},
{name:'Kript√≥n',symbol:'Kr',number:36,family:'Gas noble'},
{name:'Rubidio',symbol:'Rb',number:37,family:'Metal alcalino'},
{name:'Estroncio',symbol:'Sr',number:38,family:'Alcalinot√©rreo'},
{name:'Itrio',symbol:'Y',number:39,family:'Metal de transici√≥n'},
{name:'Zirconio',symbol:'Zr',number:40,family:'Metal de transici√≥n'},
{name:'Niobio',symbol:'Nb',number:41,family:'Metal de transici√≥n'},
{name:'Molibdeno',symbol:'Mo',number:42,family:'Metal de transici√≥n'},
{name:'Tecnecio',symbol:'Tc',number:43,family:'Metal de transici√≥n'},
{name:'Rutenio',symbol:'Ru',number:44,family:'Metal de transici√≥n'},
{name:'Rodio',symbol:'Rh',number:45,family:'Metal de transici√≥n'},
{name:'Paladio',symbol:'Pd',number:46,family:'Metal de transici√≥n'},
{name:'Plata',symbol:'Ag',number:47,family:'Metal de transici√≥n'},
{name:'Cadmio',symbol:'Cd',number:48,family:'Metal de transici√≥n'},
{name:'Indio',symbol:'In',number:49,family:'Metal postransici√≥n'},
{name:'Esta√±o',symbol:'Sn',number:50,family:'Metal postransici√≥n'},
{name:'Antimonio',symbol:'Sb',number:51,family:'Metaloide'},
{name:'Telurio',symbol:'Te',number:52,family:'Metaloide'},
{name:'Yodo',symbol:'I',number:53,family:'Hal√≥geno'},
{name:'Xen√≥n',symbol:'Xe',number:54,family:'Gas noble'},
{name:'Cesio',symbol:'Cs',number:55,family:'Metal alcalino'},
{name:'Bario',symbol:'Ba',number:56,family:'Alcalinot√©rreo'},
{name:'Lantano',symbol:'La',number:57,family:'Lant√°nido'},
{name:'Cerio',symbol:'Ce',number:58,family:'Lant√°nido'},
{name:'Praseodimio',symbol:'Pr',number:59,family:'Lant√°nido'},
{name:'Neodimio',symbol:'Nd',number:60,family:'Lant√°nido'},
{name:'Prometio',symbol:'Pm',number:61,family:'Lant√°nido'},
{name:'Samario',symbol:'Sm',number:62,family:'Lant√°nido'},
{name:'Europio',symbol:'Eu',number:63,family:'Lant√°nido'},
{name:'Gadolinio',symbol:'Gd',number:64,family:'Lant√°nido'},
{name:'Terbio',symbol:'Tb',number:65,family:'Lant√°nido'},
{name:'Disprosio',symbol:'Dy',number:66,family:'Lant√°nido'},
{name:'Holmio',symbol:'Ho',number:67,family:'Lant√°nido'},
{name:'Erbio',symbol:'Er',number:68,family:'Lant√°nido'},
{name:'Tulio',symbol:'Tm',number:69,family:'Lant√°nido'},
{name:'Iterbio',symbol:'Yb',number:70,family:'Lant√°nido'},
{name:'Lutecio',symbol:'Lu',number:71,family:'Lant√°nido'},
{name:'Hafnio',symbol:'Hf',number:72,family:'Metal de transici√≥n'},
{name:'T√°ntalo',symbol:'Ta',number:73,family:'Metal de transici√≥n'},
{name:'Wolframio',symbol:'W',number:74,family:'Metal de transici√≥n'},
{name:'Renio',symbol:'Re',number:75,family:'Metal de transici√≥n'},
{name:'Osmio',symbol:'Os',number:76,family:'Metal de transici√≥n'},
{name:'Iridio',symbol:'Ir',number:77,family:'Metal de transici√≥n'},
{name:'Platino',symbol:'Pt',number:78,family:'Metal de transici√≥n'},
{name:'Oro',symbol:'Au',number:79,family:'Metal de transici√≥n'},
{name:'Mercurio',symbol:'Hg',number:80,family:'Metal de transici√≥n'},
{name:'Talio',symbol:'Tl',number:81,family:'Metal postransici√≥n'},
{name:'Plomo',symbol:'Pb',number:82,family:'Metal postransici√≥n'},
{name:'Bismuto',symbol:'Bi',number:83,family:'Metal postransici√≥n'},
{name:'Polonio',symbol:'Po',number:84,family:'Metaloide'},
{name:'Astato',symbol:'At',number:85,family:'Hal√≥geno'},
{name:'Rad√≥n',symbol:'Rn',number:86,family:'Gas noble'},
{name:'Francio',symbol:'Fr',number:87,family:'Metal alcalino'},
{name:'Radio',symbol:'Ra',number:88,family:'Alcalinot√©rreo'},
{name:'Actinio',symbol:'Ac',number:89,family:'Act√≠nido'},
{name:'Torio',symbol:'Th',number:90,family:'Act√≠nido'},
{name:'Protactinio',symbol:'Pa',number:91,family:'Act√≠nido'},
{name:'Uranio',symbol:'U',number:92,family:'Act√≠nido'},
{name:'Neptunio',symbol:'Np',number:93,family:'Act√≠nido'},
{name:'Plutonio',symbol:'Pu',number:94,family:'Act√≠nido'},
{name:'Americio',symbol:'Am',number:95,family:'Act√≠nido'},
{name:'Curio',symbol:'Cm',number:96,family:'Act√≠nido'},
{name:'Berkelio',symbol:'Bk',number:97,family:'Act√≠nido'},
{name:'Californio',symbol:'Cf',number:98,family:'Act√≠nido'},
{name:'Einsteinio',symbol:'Es',number:99,family:'Act√≠nido'},
{name:'Fermio',symbol:'Fm',number:100,family:'Act√≠nido'},
{name:'Mendelevio',symbol:'Md',number:101,family:'Act√≠nido'},
{name:'Nobelio',symbol:'No',number:102,family:'Act√≠nido'},
{name:'Lawrencio',symbol:'Lr',number:103,family:'Act√≠nido'},
{name:'Rutherfordio',symbol:'Rf',number:104,family:'Metal de transici√≥n'},
{name:'Dubnio',symbol:'Db',number:105,family:'Metal de transici√≥n'},
{name:'Seaborgio',symbol:'Sg',number:106,family:'Metal de transici√≥n'},
{name:'Bohrio',symbol:'Bh',number:107,family:'Metal de transici√≥n'},
{name:'Hassio',symbol:'Hs',number:108,family:'Metal de transici√≥n'},
{name:'Meitnerio',symbol:'Mt',number:109,family:'Metal de transici√≥n'},
{name:'Darmstadtio',symbol:'Ds',number:110,family:'Metal de transici√≥n'},
{name:'Roentgenio',symbol:'Rg',number:111,family:'Metal de transici√≥n'},
{name:'Copernicio',symbol:'Cn',number:112,family:'Metal de transici√≥n'},
{name:'Nihonio',symbol:'Nh',number:113,family:'Metal postransici√≥n'},
{name:'Flerovio',symbol:'Fl',number:114,family:'Metal postransici√≥n'},
{name:'Moscovio',symbol:'Mc',number:115,family:'Metal postransici√≥n'},
{name:'Livermorio',symbol:'Lv',number:116,family:'Metal postransici√≥n'},
{name:'Tenesino',symbol:'Ts',number:117,family:'Hal√≥geno'},
{name:'Oganes√≥n',symbol:'Og',number:118,family:'Gas noble'}
];

// Ligas finales
const LEAGUES = [
  { name: 'Segunda Divisi√≥n', kinds: ['symbol','nameFromSymbol'] }, // s√≠mbolo ‚Üî elemento
  { name: 'Primera Divisi√≥n', kinds: ['number'] },                 // solo n√∫mero at√≥mico
  { name: 'Liga Inglesa',     kinds: ['family'] },                 // solo familias
  { name: 'Champions League', kinds: ['symbol','nameFromSymbol','number','family'] }, // todo mezclado
];

let leagueIndex = 0;
let mode = 'timed'; // 'timed' or 'exam'
let examTotal = 0, examAnswered = 0, examCorrect = 0;
const weakSet = new Map();

let homeGoals=0, guestGoals=0;
let correct=0, wrong=0;
let timeLeft=60;
let locked=false;
let jokers=3;
let correctValue=null;
let nextTimer=null;
let currentEl=null;
let currentKind=null;
let gameActive=false; // starts once first question is built
let paused=false;

// Spaced repetition
let answered = 0;
let streak = 0;
const reviewMap = new Map(); // symbol -> { el, dueIn, level }
function scheduleReview(el, bump=1){
  const key = el.symbol;
  const cur = reviewMap.get(key);
  const nextLevel = Math.min(4, (cur?.level || 0) + bump);
  const dueIn = [2,3,5,8,12][nextLevel] || 3;
  reviewMap.set(key, { el, dueIn, level: nextLevel });
}
function markMastered(el){
  const key = el.symbol;
  const cur = reviewMap.get(key);
  if(!cur) return;
  const nextLevel = Math.max(0, cur.level - 1);
  if(nextLevel === 0) reviewMap.delete(key);
  else reviewMap.set(key, { el: cur.el, dueIn: [4,6,10,14][nextLevel-1] || 6, level: nextLevel });
}
function tickReviewQueue(){
  for(const [k,v] of reviewMap) {
    v.dueIn -= 1;
    reviewMap.set(k,v);
  }
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function pickElementForQuestion(){
  const due = [];
  for(const v of reviewMap.values()) if(v.dueIn <= 0) due.push(v.el);
  return due.length ? pick(due) : pick(ELEMENTS);
}

function pad2(n){ return String(n).padStart(2,'0'); }
function updateClock(){
  if(mode==='exam') return; // keep "EXAM"
  const m = Math.floor(timeLeft/60);
  const s = timeLeft%60;
  document.getElementById('clock').textContent = `${pad2(m)}:${pad2(s)}`;
}
function setScores(){
  document.getElementById('homeScore').textContent = pad2(homeGoals);
  document.getElementById('guestScore').textContent = pad2(guestGoals);
  document.getElementById('correct').textContent = correct;
  document.getElementById('wrong').textContent = wrong;
}
function vibrate(pattern){ try{ if(navigator.vibrate) navigator.vibrate(pattern); }catch(e){} }

function showFlash(type, text){
  const el = document.getElementById('flash');
  el.className = 'flashText ' + (type==='goal' ? 'goal' : 'miss');
  el.textContent = text;
  void el.offsetWidth;
  el.classList.add(type==='goal' ? 'showGoal' : 'showMiss');
}
function getFact(el, kind){
  if(kind==='symbol') return `S√≠mbolo: ${el.symbol} ¬∑ N√∫mero: ${el.number} ¬∑ Familia: ${el.family}`;
  if(kind==='number') return `N√∫mero at√≥mico: ${el.number} ¬∑ S√≠mbolo: ${el.symbol} ¬∑ Familia: ${el.family}`;
  if(kind==='family') return `Familia: ${el.family} ¬∑ S√≠mbolo: ${el.symbol} ¬∑ N√∫mero: ${el.number}`;
  return `${el.name} ¬∑ N√∫mero: ${el.number} ¬∑ Familia: ${el.family}`;
}

function openModal(id){ const m=document.getElementById(id); if(!m) return; m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
function closeModal(id){ const m=document.getElementById(id); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }

function setLeague(idx){
  leagueIndex = Math.max(0, Math.min(LEAGUES.length-1, idx));
  document.getElementById('leagueName').textContent =
    (leagueIndex===3 ? 'Champions League' : LEAGUES[leagueIndex].name);
}

function resetRoundState(){
  if(nextTimer) clearTimeout(nextTimer);
  homeGoals=0; guestGoals=0;
  correct=0; wrong=0;
  answered=0; streak=0;
  reviewMap.clear();
  weakSet.clear();
  locked=false;
  jokers=3;
  correctValue=null;
  currentEl=null;
  currentKind=null;
  gameActive=false;
  paused=true;
  document.getElementById('jokersLeft').textContent = jokers;
  document.getElementById('fact').textContent = '';
  document.getElementById('question').textContent = '';
  document.getElementById('options').innerHTML = '';
  document.getElementById('flash').className = 'flashText';
  document.getElementById('flash').textContent = '';
  document.getElementById('examPill').style.display='none';
  document.getElementById('examProg').textContent='0/0';
  setScores();
}

function setModeTimed(){
  mode='timed';
  timeLeft=60;
  document.getElementById('clock').textContent='01:00';
  updateClock();
  document.getElementById('examPill').style.display='none';
}
function setModeExam(total){
  mode='exam';
  examTotal = Math.max(5, Math.min(60, total|0));
  examAnswered=0; examCorrect=0;
  document.getElementById('examPill').style.display='inline-flex';
  document.getElementById('examProg').textContent = `${examAnswered}/${examTotal}`;
  document.getElementById('clock').textContent='EXAM';
}

function endGame(){
  if(mode==='exam') {
    const total=examTotal;
    const pct = total ? Math.round((examCorrect/total)*100) : 0;
    document.getElementById('resultBig').textContent = `${examCorrect}/${total}  (${pct}%)`;
    document.getElementById('resultStats').textContent = `‚úÖ Correctas: ${examCorrect} ¬∑ ‚ùå Incorrectas: ${total-examCorrect}`;
    const list = document.getElementById('weakList');
    list.innerHTML='';
    const arr=[...weakSet.values()].sort((a,b)=>b.count-a.count).slice(0,14);
    if(arr.length===0) {
      list.innerHTML = '<div class="tag">¬°Perfecto! No hay errores üéâ</div>';
    } else {
      arr.forEach(it=>{
        const d=document.createElement('div');
        d.className='tag';
        d.textContent = `${it.symbol} ‚Äî ${it.name} (x${it.count})`;
        list.appendChild(d);
      });
    }
    openModal('resultModal');
    return;
  }
  alert(`¬°Final del partido!\n\nHOME (Kyle): ${homeGoals}\nGUEST (Portera): ${guestGoals}\n\n‚úÖ Correctas: ${correct}\n‚ùå Fallos: ${wrong}`);
  location.reload();
}

function pauseGame(){
  paused = true;
  locked = true;
  try{ if(nextTimer) clearTimeout(nextTimer); }catch(e){}
}
function resumeGame(){
  paused = false;
  locked = false;
}

function endCurrentGame(){
  pauseGame();
  gameActive = false;
  if(mode==='exam' && examAnswered>0){
    endGame();
    return;
  }
  resetRoundState();
}

function buildQuestion(){
  paused=false;
  locked=false;
  gameActive=true;
  document.getElementById('flash').textContent='';
  document.getElementById('flash').className='flashText';
  document.getElementById('fact').textContent='';

  const el = pickElementForQuestion();
  const kind = pick(LEAGUES[leagueIndex].kinds);
  currentEl = el;
  currentKind = kind;

  let q='', correctAns=null, pool=null;

  if(kind==='symbol'){
    q = `¬øCu√°l es el s√≠mbolo del elemento "${el.name}"?`;
    correctAns = el.symbol;
    pool = ELEMENTS.map(e=>e.symbol);
  } else if(kind==='number'){
    q = `¬øCu√°l es el n√∫mero at√≥mico de "${el.name}"?`;
    correctAns = el.number;
    pool = ELEMENTS.map(e=>e.number);
  } else if(kind==='family'){
    q = `¬øA qu√© familia pertenece "${el.name}"?`;
    correctAns = el.family;
    pool = ELEMENTS.map(e=>e.family);
  } else {
    q = `¬øQu√© elemento corresponde al s√≠mbolo "${el.symbol}"?`;
    correctAns = el.name;
    pool = ELEMENTS.map(e=>e.name);
  }

  correctValue = correctAns;

  const opts = new Set([correctAns]);
  while(opts.size<4) opts.add(pick(pool));
  const list = [...opts].sort(()=>Math.random()-0.5);

  document.getElementById('question').textContent = q;
  const box=document.getElementById('options');
  box.innerHTML='';
  list.forEach(v=>{
    const b=document.createElement('button');
    b.className='option';
    b.textContent=v;
    b.onclick=()=>selectAnswer(b,v,correctAns);
    box.appendChild(b);
  });
}

function selectAnswer(btn,val,correctAns){
  if(paused) return;
  if(locked) return;
  locked=true;

  document.querySelectorAll('.option').forEach(b=>b.disabled=true);

  answered++;
  tickReviewQueue();

  if(val===correctAns){
    btn.classList.add('correct');
    correct++;
    homeGoals++;
    streak++;
    markMastered(currentEl);
    document.getElementById('fact').innerHTML = '<strong>Bien:</strong> ' + getFact(currentEl, currentKind);
    showFlash('goal','GOOOOOL!');
    playGoalSfx();
    vibrate(60);
  } else {
    btn.classList.add('wrong');
    wrong++;
    guestGoals++;
    streak=0;
    scheduleReview(currentEl, 1);
    document.getElementById('fact').innerHTML = '<strong>Correcci√≥n:</strong> ' + getFact(currentEl, currentKind);
    showFlash('miss','PORTERA ‚òπÔ∏è');
    playMissSfx();
    vibrate([40,40,40]);

    // highlight correct and make it one-click to continue
    document.querySelectorAll('.option').forEach(b=>{
      if(b.textContent==String(correctAns)){
        b.classList.add('correct');
        b.disabled=false;
        const once = ()=>{ if(nextTimer) clearTimeout(nextTimer); buildQuestion(); };
        b.addEventListener('click', once, { once:true });
      }
    });

    if(mode==='exam'){
      const key=currentEl.symbol;
      const cur=weakSet.get(key) || {name:currentEl.name,symbol:currentEl.symbol,count:0};
      cur.count++;
      weakSet.set(key,cur);
    }
  }

  setScores();

  if(mode==='exam'){
    examAnswered++;
    if(val===correctAns) examCorrect++;
    document.getElementById('examProg').textContent = `${examAnswered}/${examTotal}`;
    if(examAnswered>=examTotal){
      if(nextTimer) clearTimeout(nextTimer);
      nextTimer = setTimeout(()=>endGame(), 650);
      return;
    }
  }

  if(nextTimer) clearTimeout(nextTimer);
  nextTimer = setTimeout(()=>buildQuestion(), 950);
}

document.getElementById('jokerBtn').onclick = () => {
  if(locked) return;
  if(jokers<=0) return;
  jokers--;
  document.getElementById('jokersLeft').textContent = jokers;

  const opts=[...document.querySelectorAll('.option')].filter(b=>!b.classList.contains('hidden'));
  const wrongs=opts.filter(b=>b.textContent!=String(correctValue));
  let hideCount=Math.min(2, wrongs.length-1);
  wrongs.sort(()=>Math.random()-0.5);
  for(let i=0;i<hideCount;i++){ wrongs[i].classList.add('hidden'); wrongs[i].disabled=true; }
};

// ---- SFX (Web Audio) ----
let sfxOn = true;
let audioCtx = null;

function loadPrefs(){
  try{ const v=localStorage.getItem('pl_sfxOn'); if(v!==null) sfxOn=(v==='1'); }catch(e){}
  updateSfxBtn();
}
function savePrefs(){ try{ localStorage.setItem('pl_sfxOn', sfxOn ? '1' : '0'); }catch(e){} }
function updateSfxBtn(){
  const b=document.getElementById('sfxBtn');
  b.textContent = sfxOn ? 'üîä SFX: ON' : 'üîá SFX: OFF';
  b.classList.toggle('toggleOff', !sfxOn);
}
function ensureAudio(){
  if(!sfxOn) return null;
  try{
    if(!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
    }
    if(audioCtx.state==='suspended') audioCtx.resume().catch(()=>{});
    return audioCtx;
  }catch(e){ return null; }
}
function tone(freq, start, dur, type='sine', gain=0.08){
  const ctx=ensureAudio(); if(!ctx) return;
  const o=ctx.createOscillator(); const g=ctx.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,start);
  g.gain.setValueAtTime(0.0001,start);
  g.gain.exponentialRampToValueAtTime(gain,start+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,start+dur);
  o.connect(g); g.connect(ctx.destination);
  o.start(start); o.stop(start+dur+0.02);
}
function noiseBurst(start, dur, gain=0.06){
  const ctx=ensureAudio(); if(!ctx) return;
  const size=Math.floor(ctx.sampleRate*dur);
  const buffer=ctx.createBuffer(1,size,ctx.sampleRate);
  const data=buffer.getChannelData(0);
  for(let i=0;i<size;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/size,2);
  const src=ctx.createBufferSource(); src.buffer=buffer;
  const g=ctx.createGain(); g.gain.setValueAtTime(gain,start);
  g.gain.exponentialRampToValueAtTime(0.0001,start+dur);
  const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.setValueAtTime(1800,start);
  src.connect(lp); lp.connect(g); g.connect(ctx.destination);
  src.start(start); src.stop(start+dur+0.02);
}
function playGoalSfx(){
  const ctx=ensureAudio(); if(!ctx) return;
  const t0=ctx.currentTime;
  tone(523.25,t0+0.00,0.14,'square',0.05);
  tone(659.25,t0+0.13,0.14,'square',0.05);
  tone(783.99,t0+0.26,0.20,'square',0.05);
  tone(1046.5,t0+0.45,0.22,'sawtooth',0.04);
  noiseBurst(t0+0.05,0.55,0.05);
}
function playMissSfx(){
  const ctx=ensureAudio(); if(!ctx) return;
  const t0=ctx.currentTime;
  tone(392.00,t0+0.00,0.18,'sine',0.06);
  tone(329.63,t0+0.16,0.20,'sine',0.055);
  tone(261.63,t0+0.34,0.26,'sine',0.05);
  noiseBurst(t0+0.00,0.20,0.02);
}

document.getElementById('sfxBtn').onclick = () => {
  sfxOn = !sfxOn;
  savePrefs();
  updateSfxBtn();
  ensureAudio();
  vibrate(25);
};

// ---- Menu / Confirm / Result wiring ----
function showMenu(){
  pauseGame();
  document.getElementById('examBox').style.display = (leagueIndex===3 ? 'block' : 'none');
  openModal('menuModal');
}

document.getElementById('menuBtn').onclick = () => {
  ensureAudio();
  // Pause immediately so nothing runs in background
  if(gameActive) pauseGame();
  // If we are actively playing, ask first
  if(gameActive || (mode==='exam' && examAnswered>0) || (mode==='timed' && (correct+wrong>0))) {
    openModal('confirmModal');
  } else {
    showMenu();
  }
  vibrate(15);
};
document.getElementById('closeMenuBtn').onclick = () => {
  closeModal('menuModal');
  // If user just peeked at menu, resume current game
  if(gameActive) resumeGame();
};

document.querySelectorAll('.leagueBtn').forEach(btn=>{
  btn.onclick = () => {
    const idx=parseInt(btn.getAttribute('data-league'),10);
    setLeague(idx);
    document.getElementById('examBox').style.display = (idx===3 ? 'block' : 'none');

    if(idx !== 3) {
      resetRoundState();
      setModeTimed();
      closeModal('menuModal');
      buildQuestion();
    }
  };
});

document.getElementById('startExamBtn').onclick = () => {
  setLeague(3);
  resetRoundState();
  const n=parseInt(document.getElementById('examCount').value,10) || 20;
  setModeExam(n);
  closeModal('menuModal');
  buildQuestion();
};

document.getElementById('closeConfirmBtn').onclick = () => {
  closeModal('confirmModal');
  resumeGame();
};
document.getElementById('cancelExitBtn').onclick = () => {
  closeModal('confirmModal');
  // Resume only if a game was in progress
  if(mode==='timed' && timeLeft>0 && (correct+wrong>=0)) resumeGame();
  if(mode==='exam' && examAnswered>=0) resumeGame();
};
document.getElementById('confirmExitBtn').onclick = () => {
  closeModal('confirmModal');
  endCurrentGame();
  // stay paused in menu
  showMenu();
};

document.getElementById('closeResultBtn').onclick = () => closeModal('resultModal');
document.getElementById('backToMenuBtn').onclick = () => { closeModal('resultModal'); showMenu(); };
document.getElementById('restartExamBtn').onclick = () => {
  const n=parseInt(document.getElementById('examCount').value,10) || 20;
  resetRoundState();
  setLeague(3);
  setModeExam(n);
  closeModal('resultModal');
  buildQuestion();
};

// Timer tick (only timed)
setInterval(()=>{
  if(mode!=='timed') return;
  if(paused || !gameActive) return;
  timeLeft--;
  if(timeLeft<0) timeLeft=0;
  updateClock();
  if(timeLeft===0) endGame();
},1000);

// Boot
loadPrefs();
setLeague(0);
setModeTimed();
setScores();
buildQuestion();
</script>
</body>
</html>
